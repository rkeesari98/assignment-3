<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelShare - Create Post</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --theme-primary: #5e35b1;
            --theme-primary-light: #9162e4;
            --theme-primary-dark: #280680;
            --theme-secondary: #26a69a;
            --theme-text-dark: #424242;
            --theme-text-light: #757575;
            --theme-background: #f5f5f5;
            --theme-card: #ffffff;
            --theme-border: #e0e0e0;
        }
        
        body {
            background-color: var(--theme-background);
            color: var(--theme-text-dark);
            font-family: 'Roboto', sans-serif;
        }
        
        nav {
            background-color: var(--theme-card);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        nav .brand-logo {
            color: var(--theme-primary);
            font-weight: 700;
        }
        
        .nav-content {
            background-color: var(--theme-card);
        }
        
        .tabs .tab a {
            color: var(--theme-primary-light);
        }
        
        .tabs .tab a:hover, .tabs .tab a.active {
            color: var(--theme-primary);
        }
        
        .tabs .indicator {
            background-color: var(--theme-primary);
        }
        
        .main-container {
            margin-top: 20px;
            padding-bottom: 40px;
        }
        
        .card {
            border-radius: 12px;
            overflow: hidden;
        }
        
        .card .card-title {
            color: var(--theme-primary);
        }
        
        .btn-theme {
            background-color: var(--theme-primary);
        }
        
        .btn-theme:hover {
            background-color: var(--theme-primary-light);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--theme-primary);
            color: var(--theme-primary);
        }
        
        .btn-outline:hover {
            background-color: rgba(94, 53, 177, 0.1);
        }
        
        /* Drop Zone Styles */
        .drop-zone {
            min-height: 300px;
            border: 2px dashed var(--theme-primary-light);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: rgba(94, 53, 177, 0.05);
        }
        
        .drop-zone:hover {
            background-color: rgba(94, 53, 177, 0.1);
        }
        
        .drop-zone.highlight {
            border-color: var(--theme-primary);
            background-color: rgba(94, 53, 177, 0.2);
        }
        
        .drop-zone-prompt {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--theme-primary);
        }
        
        .drop-zone-thumb {
            width: 100%;
            height: 100%;
            max-height: 300px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f5f5f5;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        
        .thumb-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            padding: 5px;
            cursor: pointer;
        }
        
        .hidden {
            display: none;
        }
        
        .character-counter {
            text-align: right;
            font-size: 12px;
            color: var(--theme-text-light);
        }
        
        .auth-pending {
            visibility: hidden;
        }

        /* Sidenav styles */
        .sidenav {
            width: 250px;
        }
        
        .sidenav li > a {
            display: flex;
            align-items: center;
            padding: 0 16px;
            height: 50px;
        }
        
        .sidenav li > a > i {
            margin-right: 16px;
        }
        
        /* Preloader */
        .progress {
            margin: 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            z-index: 9999;
            display: none;
        }
        
        .progress .indeterminate {
            background-color: var(--theme-primary);
        }
    </style>
</head>

<body>
    <div class="progress" id="page-loader">
        <div class="indeterminate"></div>
    </div>
    
    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper container">
                <a href="/" class="brand-logo">PixelShare</a>
                <a href="#" data-target="mobile-nav" class="sidenav-trigger"><i class="material-icons">menu</i></a>
                <ul class="right hide-on-med-and-down">
                    <li><a href="/"><i class="material-icons">home</i></a></li>
                    <li><a href="/explore"><i class="material-icons">explore</i></a></li>
                    <li><a href="/create" class="active"><i class="material-icons">add_box</i></a></li>
                    <li><a href="/profile"><i class="material-icons">person</i></a></li>
                    <li><a href="#" id="desktop-logout" class="hidden"><i class="material-icons">exit_to_app</i></a></li>
                </ul>
            </div>
        </nav>
    </div>
    
    <ul class="sidenav" id="mobile-nav">
        <li>
            <div class="user-view">
                <div class="background" style="background-color: var(--theme-primary);"></div>
                <a href="/profile"><img class="circle" id="sidenav-user-image" src="/static/default-profile.jpg"></a>
                <a href="/profile"><span class="white-text name" id="sidenav-username">Guest User</span></a>
                <a href="#"><span class="white-text email" id="sidenav-email">Not signed in</span></a>
            </div>
        </li>
        <li><a href="/"><i class="material-icons">home</i>Home</a></li>
        <li><a href="/explore"><i class="material-icons">explore</i>Explore</a></li>
        <li><a href="/create"><i class="material-icons">add_box</i>Create Post</a></li>
        <li><a href="/profile"><i class="material-icons">person</i>Profile</a></li>
        <li><div class="divider"></div></li>
        <li><a href="#" id="mobile-logout" class="hidden"><i class="material-icons">exit_to_app</i>Sign Out</a></li>
    </ul>

    <div id="auth-modal" class="modal auth-pending">
        <div class="modal-content">
            <h4>Sign In</h4>
            <p>Please sign in to continue using PixelShare</p>
            
            <div class="row">
                <div class="input-field col s12">
                    <i class="material-icons prefix">email</i>
                    <input id="email" type="email" class="validate">
                    <label for="email">Email</label>
                </div>
                <div class="input-field col s12">
                    <i class="material-icons prefix">lock</i>
                    <input id="password" type="password" class="validate">
                    <label for="password">Password</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="login-btn" class="btn waves-effect waves-light btn-theme">Sign In</button>
            <div class="center-align">
                <span>or</span>
            </div>
            <button id="signup-btn" class="btn waves-effect waves-light btn-outline">Sign Up</button>
        </div>
    </div>

    <div class="container main-container">
        <div class="row" id="content">
            <div class="col s12 m10 offset-m1 l8 offset-l2">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title center-align">Create New Post</span>
                        
                        <form id="create-post-form">
                            <div class="row">
                                <div class="col s12 m6">
                                    <div id="drop-zone-container">
                                        <div class="drop-zone" id="drop-zone">
                                            <span class="drop-zone-prompt">
                                                <i class="material-icons large">cloud_upload</i>
                                            </span>
                                            <p>Drop image here or click to upload</p>
                                            <span class="grey-text text-darken-1">JPG or PNG only</span>
                                            <input type="file" name="image" id="image-upload" class="hidden" accept="image/png, image/jpeg">
                                        </div>
                                        <div class="drop-zone-thumb hidden" id="image-preview">
                                            <span class="thumb-close"><i class="material-icons">close</i></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col s12 m6">
                                    <div class="input-field">
                                        <i class="material-icons prefix">subject</i>
                                        <textarea id="caption" name="caption" class="materialize-textarea" data-length="500" required></textarea>
                                        <label for="caption">Write a caption...</label>
                                        <span id="caption-counter" class="character-counter">0/500</span>
                                    </div>
                                    
                                    <div class="input-field">
                                        <i class="material-icons prefix">location_on</i>
                                        <input type="text" id="location" name="location">
                                        <label for="location">Add location (optional)</label>
                                    </div>
                                    
                                    
                                    
                                    <div class="input-field" style="margin-top: 40px;">
                                        <button type="submit" class="btn waves-effect waves-light btn-theme w-100" style="width: 100%;">
                                            Share Post
                                            <i class="material-icons right">send</i>
                                        </button>
                                        <a href="javascript:history.back()" class="btn waves-effect waves-light btn-outline w-100" style="width: 100%; margin-top: 10px;">
                                            Cancel
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <script type="module" src="/static/firebase-login.js"></script>
    
    <script>
       document.addEventListener('DOMContentLoaded', function() {
    M.AutoInit();
    
    const captionField = document.getElementById('caption');
    const captionCounter = document.getElementById('caption-counter');
    const maxCaptionLength = 500;
    const dropZone = document.getElementById('drop-zone');
    const imageUpload = document.getElementById('image-upload');
    const imagePreview = document.getElementById('image-preview');
    
    // Caption counter functionality
    captionField.addEventListener('input', function() {
        const length = this.value.length;
        captionCounter.textContent = `${length}/${maxCaptionLength}`;
        
        if (length > maxCaptionLength) {
            captionCounter.classList.add('red-text');
        } else {
            captionCounter.classList.remove('red-text');
        }
    });
    
    // Click on drop zone to trigger file input
    dropZone.addEventListener('click', () => {
        imageUpload.click();
    });
    
    // Handle file selection via input
    imageUpload.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            console.log("File selected through input:", file.name);
            handleImageFile(file);
        }
    });
    
    // Drag and drop functionality
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('highlight');
    });
    
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('highlight');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('highlight');
        
        if (e.dataTransfer.files.length) {
            const file = e.dataTransfer.files[0];
            console.log("File dropped:", file.name);
            imageUpload.files = e.dataTransfer.files;
            handleImageFile(file);
        }
    });
    
    // Handle close button click
    document.querySelector('.thumb-close').addEventListener('click', function(e) {
        console.log("Close button clicked");
        imageUpload.value = '';
        imagePreview.classList.add('hidden');
        dropZone.classList.remove('hidden');
        imagePreview.style.backgroundImage = '';
    });
    
    // Function to handle the image file
    function handleImageFile(file) {
        // Check file type
        const fileType = file.type;
        console.log("File type:", fileType);
        
        if (fileType !== 'image/jpeg' && fileType !== 'image/png') {
            M.toast({html: 'Please upload a JPG or PNG image only.', classes: 'red'});
            return;
        }
        
        // Create a new FileReader
        const reader = new FileReader();
        
        // Set up the onload event
        reader.onload = function(e) {
            console.log("FileReader loaded successfully");
            
            // Instead of setting background image, let's try creating an actual image element
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100%';
            img.style.height = 'auto';
            img.style.objectFit = 'contain';
            
            // Clear any existing content in the preview
            imagePreview.innerHTML = '';
            // Add the close button back
            const closeBtn = document.createElement('span');
            closeBtn.className = 'thumb-close';
            closeBtn.innerHTML = '<i class="material-icons">close</i>';
            closeBtn.addEventListener('click', function() {
                console.log("New close button clicked");
                imageUpload.value = '';
                imagePreview.classList.add('hidden');
                dropZone.classList.remove('hidden');
                imagePreview.innerHTML = '';
            });
            
            // Append the image and close button
            imagePreview.appendChild(img);
            imagePreview.appendChild(closeBtn);
            
            // Hide the drop zone and show the preview
            console.log("Before changing visibility - dropZone hidden?", dropZone.classList.contains('hidden'));
            console.log("Before changing visibility - imagePreview hidden?", imagePreview.classList.contains('hidden'));
            
            dropZone.classList.add('hidden');
            imagePreview.classList.remove('hidden');
            
            console.log("After changing visibility - dropZone hidden?", dropZone.classList.contains('hidden'));
            console.log("After changing visibility - imagePreview hidden?", imagePreview.classList.contains('hidden'));
            
            console.log('Image preview element:', imagePreview);
            console.log('Image preview displayed!');
        };
        
        // Read the file as a data URL
        reader.readAsDataURL(file);
    }
    
    // Form submission handler
    document.getElementById('create-post-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!imageUpload.files.length) {
            M.toast({html: 'Please select an image for your post.', classes: 'red'});
            dropZone.classList.add('highlight');
            setTimeout(() => dropZone.classList.remove('highlight'), 3000);
            return;
        }
        
        if (captionField.value.length > maxCaptionLength) {
            M.toast({html: `Caption cannot exceed ${maxCaptionLength} characters.`, classes: 'red'});
            captionField.focus();
            return;
        }
        
        const loader = document.getElementById('page-loader');
        loader.style.display = 'block';
        
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalHtml = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Uploading...';
        
        try {
            const imageFormData = new FormData();
            imageFormData.append('file_name', imageUpload.files[0]);
            
            const uploadResponse = await fetch('/upload-file', {
                method: 'POST',
                body: imageFormData
            });
            
            const uploadData = await uploadResponse.json();
            if (!uploadResponse.ok) {
                throw new Error(uploadData.error || 'Failed to upload image');
            }
            
            const filename = uploadData.filename || uploadData.content;
            
            submitBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Creating post...';
            
            const postData = {
                image_ref: filename,
                caption: captionField.value,
                location: document.getElementById('location').value || null,

            };
            
            const postResponse = await fetch('/post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
            });
            
            const postResult = await postResponse.json();
            if (!postResponse.ok) {
                throw new Error(postResult.message || 'Failed to create post');
            }
            
            M.toast({html: 'Post created successfully!', classes: 'green'});
            setTimeout(() => {
                window.location.href = '/profile';
            }, 1000);
            
        } catch (error) {
            console.error('Error creating post:', error);
            M.toast({html: `Error: ${error.message}`, classes: 'red'});
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalHtml;
        } finally {
            loader.style.display = 'none';
        }
    });
});
    </script>
</body>
</html>